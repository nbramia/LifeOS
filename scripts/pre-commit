#!/bin/bash
#
# LifeOS Pre-commit Hook
#
# Runs fast unit tests before allowing commits.
# Slow tests (ChromaDB, embeddings) are skipped for speed.
#
# Test markers:
#   @pytest.mark.unit        - Fast unit tests (run on commit)
#   @pytest.mark.slow        - Slow tests (ChromaDB, embeddings)
#   @pytest.mark.integration - Integration tests (require running server)
#
# Installation:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Run all tests manually:
#   pytest tests/ -v             # All tests
#   pytest -m unit               # Unit tests only
#   pytest -m "not slow"         # Skip slow tests
#   pytest -m "not integration"  # Skip integration tests
#

set -e

echo "========================================"
echo "  LifeOS Pre-commit Hook"
echo "  Running unit tests (fast)..."
echo "========================================"
echo ""

# Get the project root directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Activate virtual environment (located outside Documents for faster startup)
if [ -f "$HOME/.venvs/lifeos/bin/activate" ]; then
    source "$HOME/.venvs/lifeos/bin/activate"
fi

# Run only unit tests (fast) - skip slow tests that require ChromaDB or Ollama
echo "Running: python -m pytest -m 'unit and not slow' tests/ -v --tb=short"
echo ""

if python -m pytest -m "unit and not slow" tests/ -v --tb=short; then
    echo ""
    echo "========================================"
    echo "  Unit tests passed! Proceeding with commit."
    echo ""
    echo "  Run 'pytest' for full test suite."
    echo "========================================"
    exit 0
else
    echo ""
    echo "========================================"
    echo "  COMMIT BLOCKED: Unit tests failed!"
    echo ""
    echo "  Fix the failing tests before committing."
    echo "  To bypass (not recommended): git commit --no-verify"
    echo "========================================"
    exit 1
fi
